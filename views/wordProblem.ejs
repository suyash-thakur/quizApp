<%- include("./partials/header.ejs") %>
<div class="container">
    <div class="word-quiz">
      <div class="second-content">
        <% if(isDemo == true){ %>
          <p><b>This is a demo. Login for a better experience</b></p>
      <% }%>
        <p id="Instruction">Select the correct answer for the options below.</p>
       <p>
         <b>Question: <span id="currentquestion">1</span>/<span id="totalquestion"></span></b>
       </p>
      </div>
      <div class="word-question-section">
        <div id="word-question">
          <div class="text-center">
          </div>
        </div>
      </div>
      <div class="word-answers-section" id="word-quiz-section"></div>
      <div class="flash-btns">
      <div class="button-quiz" id="button-quiz">
        <a onclick="next()">Next</a>
      </div>
      <div class="button-quiz" id="button-quiz">
        <a onclick="submit()">Submit</a>
      </div>
      </div>
    </div>
  </div>

  <script>
    const question = <%- JSON.stringify(problemQuestions) %>;
    const options = <%- JSON.stringify(problemChoices) %>;
    
    let currentQuestion = 0;
    let optionsSelected = [];

    const clearFields = () => {
      document
          .querySelectorAll(".flash-option")
          .forEach((e) => {
            if(e.classList.contains("selected")){
              e.classList.remove("selected");
            }
        })
    }

    const main = () => {
        document.getElementById("word-question").innerText = question[currentQuestion];
        document.querySelector(".word-answers-section").innerHTML = generateOption(options[currentQuestion], options[currentQuestion].length)
        document.getElementById("totalquestion").innerText = question.length;
        document.getElementById("currentquestion").innerText = currentQuestion + 1;

        document
          .querySelectorAll(".flash-option")
          .forEach((e) => {
            e.addEventListener("click", (event) => {
              clearFields();
              event.target.classList.add("selected");
            })
        })
    }

    const optionHandler = () => {
      optionsSelected[currentQuestion] = getSelected() || "";
      currentQuestion += 1;
    }

    const generateOption = (values, count) => {
        let html = "";
        for(let i=0;i<count;i++){
            if(values[i] !== null){
                html += `<div class="number flash-option">${values[i]}</div>`
            }
        }
        return html;
    }

    const getSelected = () => {
        let answer;
        document.querySelectorAll(".flash-option").forEach((e) => {
            if(e.classList.contains("selected")){
              answer = e.innerText;
            }
        })

        return answer;
    }

    const next = () => {
      optionHandler();
      if (currentQuestion < question.length){
        main();
      }
      else{
        submit();
      }
    }

    const submit = () => {
      optionHandler();

      const url = "/wordProblem";
      
      const param = {
        headers: {
          "content-type": "application/json; charset=UTF-8",
        },
        body: JSON.stringify(optionsSelected),
        method: "post",
      };

      fetch(url, param)
        .then((response) => {
          response = response.json();
          return response;
        })
        .then((data) => {
          let tableData = "";
          
          data.arrayOfAnswers.forEach((answer, index) => {
            tableData += `<tr>
              <td class="table-value">${index + 1}</td>
              <td class="table-value">${answer.question}</td>
              <td class="table-value">${answer.selected}</td>
              <td class="table-value">${answer.answer}</td>
              </tr>`
            })

          document.querySelector(".word-quiz").innerHTML = 
            `
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th scope="col table-heading">Total Points</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="table-value">${data.points}</td>
                </tr>
              </tbody>
            </table>
            <br>
            <h2>Answer Sheet</h2>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th scope="col table-heading">Question No.</th>
                  <th scope="col table-heading">Question</th>
                  <th scope="col table-heading">Selected Answer</th>
                  <th scope="col table-heading">Correct Answer</th>
                </tr>
              </thead>
              <tbody>
                ${tableData}
              </tbody>
            </table>
            `
        })
    }

    main();

</script>

<%- include("./partials/footer.ejs") %>